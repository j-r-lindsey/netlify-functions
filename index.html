<html>
    <head>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js" ></script>
    </head>
    <body>
        <table border="1">
            <thead>
                <th>Date</th>
                <th>Description</th>
                <th>Path</th>
            </thead>
            <tbody id="records">

            </tbody>
        </table>

        <script>

            var orientation = "N"
            var position = [150,150];

            function forward(s,d) {
                switch (orientation) {                     
                    case "N":
                        destination = [ position[0], position[1]-d ];
                        break;
                    case "E":
                        destination = [ position[0]+d, position[1] ];
                        break;
                    case "W":
                        destination = [ position[0]-d, position[1] ];
                        break;
                    case "S":
                        destination = [ position[0], position[1]+d ];
                        break;                                                                        
                }
                s.line(position[0],position[1],destination[0],destination[1]).attr({
                    stroke: "red",
                    strokeWidth: 10
                });
                position = destination;                
            }

            function reverse(s,d) {
                forward(s, -d);
            }

            function right(d) {
                switch (orientation) {                     
                    case "N":
                        orientation = "E";
                        break;
                    case "E":
                        orientation = "S";
                        break;
                    case "W":
                        orientation = "N";
                        break;
                    case "S":
                        orientation = "W";
                        break;                                                                        
                }                
            }

            function left(d) {
                switch (orientation) {                     
                    case "N":
                        orientation = "W";
                        break;
                    case "E":
                        orientation = "N";
                        break;
                    case "W":
                        orientation = "S";
                        break;
                    case "S":
                        orientation = "E";
                        break;                                                                        
                }                  
            }

            function reset() {
                orientation = "N"
                position = [150,150];                
            }

            function getSvg(data) {
                reset();
                s = Snap(300,300);
                forward(s,20);
                right();
                forward(s,30);
                left();
                forward(s,10);
                reverse(s,50);
                return s;
            }

            $.ajax({
                url: "/.netlify/functions/save-car-path",
                success: function(data) {
                    if (data) {
                        let json = JSON.parse(data);
                        let tbody = $("#records");  
                        json.forEach((item) => { 
                            tbody.append(`<tr><td>${new Date(item.ts/1000)}</td><td>Size: ${data.length}</td><td>${getSvg(item.data)}</td><tr>`);
                        });
                    }
                }
            });            

        </script>

    </body>
</html>